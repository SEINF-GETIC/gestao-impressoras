<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISTEMA GEST√ÉO SED SC - CLOUD</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        :root { --verde-sed: #006437; --verde-escuro: #004d2a; --cinza-bg: #f4f7f6; --azul-inst: #007bff; --vermelho-sc: #dc3545; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--cinza-bg); margin: 0; padding: 0; }
        #tela-login { position: fixed; width: 100%; height: 100%; background: var(--verde-sed); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .login-box { background: white; padding: 40px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); text-align: center; width: 380px; border-top: 8px solid var(--vermelho-sc); }
        #container-principal { display: none; padding: 20px; }
        .header-main { background: white; padding: 15px 25px; border-radius: 10px; border-left: 10px solid var(--verde-sed); box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        .header-titulo h1 { margin: 0; font-size: 16px; color: var(--verde-sed); text-transform: uppercase; }
        .dashboard { display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px; margin-bottom: 20px; }
        .stat-card { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); text-align: center; border-bottom: 4px solid #ccc; }
        .stat-card b { font-size: 24px; color: var(--verde-sed); display: block; }
        .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .form-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }
        .span-2 { grid-column: span 2; } .span-4 { grid-column: span 4; }
        label { display: block; font-size: 11px; font-weight: bold; margin-bottom: 4px; color: #555; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 13px; box-sizing: border-box; }
        .btn { padding: 8px 12px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; transition: 0.3s; font-size: 12px; }
        .btn-salvar { background: var(--verde-sed); color: white; height: 42px; align-self: end; }
        .table-wrap { overflow-x: auto; max-height: 500px; border-radius: 8px; border: 1px solid #eee; background: white; }
        table { width: 100%; border-collapse: collapse; white-space: nowrap; }
        th { background: #f8f9fa; color: var(--verde-sed); font-size: 11px; padding: 12px; border-bottom: 2px solid #ddd; position: sticky; top: 0; z-index: 5; text-align: left; }
        td { padding: 10px 12px; font-size: 12px; border-bottom: 1px solid #eee; }
        .badge-status { padding: 4px 8px; border-radius: 4px; font-weight: bold; font-size: 10px; text-transform: uppercase; }
        .status-atendendo { background: #fff3cd; color: #856404; }
        .status-encerrado { background: #d4edda; color: #155724; }
        .status-instala√ß√£o { background: #cfe2ff; color: #084298; }
    </style>
</head>
<body>

    <div id="tela-login">
        <div class="login-box">
            <div style="font-size: 22px; font-weight: 800; color: var(--verde-sed);">Sistema Gest√£o SED</div>
            <div style="color: #666; font-size: 12px; margin-bottom: 25px;">Gerenciamento de Impressoras - Cloud</div>
            <input type="text" id="user-login" placeholder="Nome do Operador">
            <br><br>
            <button class="btn btn-salvar" style="width: 100%; margin:0;" onclick="fazerLogin()">ACESSAR PAINEL</button>
        </div>
    </div>

    <div id="container-principal">
        <div class="header-main">
            <div class="header-titulo"><h1>Gerenciamento Impressoras - SED SC</h1></div>
            <div style="display: flex; gap: 5px; align-items: center;">
                <span style="font-size: 12px; margin-right: 10px;">Operador: <strong id="nome-usuario-logado"></strong></span>
                <button class="btn" style="background: #e74c3c; color: white;" onclick="exportarPDF()">üìÑ PDF</button>
                <button class="btn" style="background: #27ae60; color: white;" onclick="exportarExcel()">üìä Excel</button>
                <button class="btn" style="background: #333; color: white;" onclick="location.reload()">Sair</button>
            </div>
        </div>

        <div class="dashboard">
            <div class="stat-card"><small>Total</small><b id="stat-total">0</b></div>
            <div class="stat-card"><small>Atendendo</small><b id="stat-aberto">0</b></div>
            <div class="stat-card"><small>Encerrados</small><b id="stat-ok">0</b></div>
            <div class="stat-card"><small>Instala√ß√£o</small><b id="stat-inst">0</b></div>
            <div class="stat-card"><small>Outros</small><b id="stat-mov">0</b></div>
        </div>

        <div class="card">
            <div class="form-grid">
                <div class="form-group span-2"><label>UNIDADE ESCOLAR</label><input type="text" id="unidade"></div>
                <div class="form-group"><label>MUNIC√çPIO</label><input type="text" id="municipio"></div>
                <div class="form-group"><label>CRE</label><input type="text" id="cre"></div>
                <div class="form-group"><label>TPSC</label><input type="text" id="tpsc"></div>
                <div class="form-group"><label>IMP</label><input type="text" id="chamado"></div>
                <div class="form-group">
                    <label>STATUS</label>
                    <select id="status">
                        <option>Atendendo</option>
                        <option>Instala√ß√£o</option>
                        <option>Encerrado</option>
                        <option>Troca de Equipamento</option>
                        <option>Mudan√ßa de Local</option>
                        <option>Retirada de Equipamento</option>
                    </select>
                </div>
                <button class="btn btn-salvar" id="btnSalvar" onclick="salvarRegistro()">SALVAR REGISTRO</button>
                <div class="form-group span-4"><label>OBSERVA√á√ïES</label><textarea id="defeito" rows="2"></textarea></div>
            </div>
        </div>

        <div class="card">
            <div class="table-wrap">
                <table id="tabela-dados">
                    <thead>
                        <tr>
                            <th>Data</th><th>Unidade</th><th>Munic√≠pio</th><th>CRE</th><th>TPSC</th><th>IMP</th><th>Status</th><th>Obs</th><th>Operador</th>
                        </tr>
                    </thead>
                    <tbody id="corpoTabela"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // URL DO SEU APP DA WEB (CONFORME SUA IMAGEM)
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwJsIvdBu6EDwRF-PMOYNkBpYfnCXIInwGhJKq7F7Te0yj3ZiOHVq7NfhIr6tmQS5zw0Q/exec";
        
        let usuarioLogado = "";
        let registrosParaExportar = [];

        function fazerLogin() {
            usuarioLogado = document.getElementById('user-login').value;
            if(!usuarioLogado) return alert("Informe seu nome.");
            document.getElementById('nome-usuario-logado').innerText = usuarioLogado;
            document.getElementById('tela-login').style.display = 'none';
            document.getElementById('container-principal').style.display = 'block';
            carregarTabela();
        }

        async function salvarRegistro() {
            const btn = document.getElementById('btnSalvar');
            const dados = {
                data: new Date().toLocaleString('pt-BR'),
                unidade: document.getElementById('unidade').value,
                municipio: document.getElementById('municipio').value,
                cre: document.getElementById('cre').value,
                tpsc: document.getElementById('tpsc').value,
                chamado: document.getElementById('chamado').value,
                status: document.getElementById('status').value,
                defeito: document.getElementById('defeito').value,
                usuario_reg: usuarioLogado
            };
            if(!dados.unidade) return alert("Unidade obrigat√≥ria!");
            btn.disabled = true; btn.innerText = "ENVIANDO...";

            try {
                await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(dados) });
                alert("Salvo com sucesso!");
                ['unidade', 'municipio', 'cre', 'tpsc', 'chamado', 'defeito'].forEach(id => document.getElementById(id).value = "");
                carregarTabela();
            } catch (e) { alert("Erro ao salvar."); }
            finally { btn.disabled = false; btn.innerText = "SALVAR REGISTRO"; }
        }

        async function carregarTabela() {
            const corpo = document.getElementById('corpoTabela');
            corpo.innerHTML = "<tr><td colspan='9' style='text-align:center'>Sincronizando...</td></tr>";

            try {
            // O ?t= garante que n√£o usem dados antigos salvos no navegador
            const response = await fetch(SCRIPT_URL + "?t=" + new Date().getTime());
            const dados = await response.json();
        
            console.log("Dados recebidos:", dados); // Isso ajuda a ver o erro apertando F12

            if (dados.error) {
            corpo.innerHTML = `<tr><td colspan='9' style='color:red'>Erro no Script: ${dados.error}</td></tr>`;
            return;
            }

            corpo.innerHTML = "";
            dados.reverse().forEach(v => {
                corpo.innerHTML += `
                    <tr>
                        <td>${v.data || '-'}</td>
                        <td><b>${v.unidade || '-'}</b></td>
                        <td>${v.municipio || '-'}</td>
                        <td>${v.cre || '-'}</td>
                        <td>${v.tpsc || '-'}</td>
                        <td>${v.imp || v.chamado || '-'}</td>
                        <td>${v.status || '-'}</td>
                        <td>${v.defeito || v.obs || '-'}</td>
                        <td>${v.usuario_reg || v.operador || '-'}</td>
                    </tr>`;
            });
        } catch (e) {
            corpo.innerHTML = "<tr><td colspan='9' style='color:red'>Erro de conex√£o ou permiss√£o.</td></tr>";
            console.error(e);
        }
    }

        function exportarExcel() { const ws = XLSX.utils.json_to_sheet(registrosParaExportar); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Dados"); XLSX.writeFile(wb, "Relatorio.xlsx"); }
        function exportarPDF() { const { jsPDF } = window.jspdf; const doc = new jsPDF('l'); doc.text("Relat√≥rio SED SC", 10, 10); doc.autoTable({ head: [['Data', 'Unidade', 'Status']], body: registrosParaExportar.map(v => [v.data, v.unidade, v.status]) }); doc.save("Relatorio.pdf"); }
    </script>
</body>
</html>

