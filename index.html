<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISTEMA GESTÃO SED SC v5.0</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        :root { --verde-sed: #006437; --verde-escuro: #004d2a; --cinza-bg: #f4f7f6; --vermelho-sc: #dc3545; --azul-edit: #2980b9; --cinza-filtro: #e9ecef; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--cinza-bg); margin: 0; padding: 0; }
        
        #tela-login { position: fixed; width: 100%; height: 100%; background: var(--verde-sed); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .login-box { background: white; padding: 40px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); text-align: center; width: 350px; border-top: 8px solid var(--vermelho-sc); }
        #container-principal { display: none; padding: 20px; }
        
        .header-main { background: white; padding: 15px 25px; border-radius: 10px; border-left: 10px solid var(--verde-sed); box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        .dashboard { display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px; margin-bottom: 20px; }
        .stat-card { background: white; padding: 15px; border-radius: 8px; text-align: center; border-bottom: 4px solid #ccc; }
        .stat-card b { font-size: 24px; color: var(--verde-sed); display: block; }

        .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .form-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }
        .span-2 { grid-column: span 2; } .span-4 { grid-column: span 4; }
        
        label { display: block; font-size: 11px; font-weight: bold; margin-bottom: 4px; color: #555; text-transform: uppercase; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 13px; box-sizing: border-box; }
        
        .btn { padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 12px; transition: 0.3s; }
        .btn-salvar { background: var(--verde-sed); color: white; width: 100%; height: 42px; align-self: end; }
        .btn-limpar { background: #666; color: white; height: 42px; align-self: flex-end; }
        .btn-editar { background: #f39c12; color: white; padding: 5px 10px; }

        /* SEÇÃO DE FILTROS REFINADOS */
        .filtro-refinado { background: var(--cinza-filtro); padding: 20px; border-radius: 10px; margin-bottom: 20px; display: grid; grid-template-columns: 1fr 1fr 2fr auto; gap: 15px; align-items: flex-end; }

        .table-wrap { overflow-x: auto; background: white; border-radius: 8px; border: 1px solid #eee; }
        table { width: 100%; border-collapse: collapse; white-space: nowrap; }
        th { background: #f8f9fa; color: var(--verde-sed); font-size: 11px; padding: 12px; text-align: left; border-bottom: 2px solid #ddd; position: sticky; top: 0; }
        td { padding: 10px 12px; font-size: 12px; border-bottom: 1px solid #eee; }
        
        .badge { padding: 4px 8px; border-radius: 4px; font-weight: bold; font-size: 10px; text-transform: uppercase; }
        .status-atendendo { background: #fff3cd; color: #856404; }
        .status-encerrado { background: #d4edda; color: #155724; }
        .status-instalação { background: #cfe2ff; color: #084298; }
        .status-troca { background: #e2d9f3; color: #512da8; }
        .status-retirada { background: #f8d7da; color: #842029; }
        .status-mudança { background: #e2e3e5; color: #41464b; }
    </style>
</head>
<body>

    <div id="tela-login">
        <div class="login-box">
            <h2 style="color: var(--verde-sed);">SISTEMA SED SC</h2>
            <p style="font-size: 12px; color: #666;">Acesso Administrativo v5.0</p>
            <input type="text" id="user-login" placeholder="Nome do Operador">
            <br><br>
            <button class="btn btn-salvar" onclick="fazerLogin()">ACESSAR PAINEL</button>
        </div>
    </div>

    <div id="container-principal">
        <div class="header-main">
            <h1>Gestão de Equipamentos</h1>
            <div>
                <span id="nome-usuario-logado" style="margin-right:15px; font-weight:bold;"></span>
                <button class="btn" style="background:#e74c3c; color:white;" onclick="exportarPDF()">PDF</button>
                <button class="btn" style="background:#27ae60; color:white;" onclick="exportarExcel()">Excel</button>
                <button class="btn" style="background:#333; color:white;" onclick="location.reload()">Sair</button>
            </div>
        </div>

        <div class="dashboard">
            <div class="stat-card"><small>Total</small><b id="stat-total">0</b></div>
            <div class="stat-card"><small>Atendendo</small><b id="stat-aberto">0</b></div>
            <div class="stat-card"><small>Encerrados</small><b id="stat-ok">0</b></div>
            <div class="stat-card"><small>Instalação</small><b id="stat-inst">0</b></div>
            <div class="stat-card"><small>Outros</small><b id="stat-outros">0</b></div>
        </div>

        <div class="card">
            <div class="form-grid">
                <div class="span-2"><label>UNIDADE ESCOLAR</label><input type="text" id="unidade"></div>
                <div><label>MUNICÍPIO</label><input type="text" id="municipio"></div>
                <div><label>CRE</label><input type="text" id="cre"></div>
                <div><label>TPSC</label><input type="text" id="tpsc"></div>
                <div><label>IMP (Patrimônio)</label><input type="text" id="chamado"></div>
                <div>
                    <label>STATUS</label>
                    <select id="status">
                        <option>Atendendo</option>
                        <option>Encerrado</option>
                        <option>Instalação</option>
                        <option>Troca de Equipamento</option>
                        <option>Retirada de Equipamento</option>
                        <option>Mudança de Local</option>
                    </select>
                </div>
                <div style="display: flex; gap: 5px; align-items: flex-end;">
                    <button class="btn btn-salvar" id="btnSalvar" onclick="salvarRegistro()">SALVAR REGISTRO</button>
                    <button class="btn" id="btnCancelar" style="display:none; background:#95a5a6; color:white;" onclick="cancelarEdicao()">X</button>
                </div>
                <div class="span-4"><label>OBSERVAÇÕES / DETALHES</label><textarea id="defeito" rows="2"></textarea></div>
            </div>
        </div>

        <div class="filtro-refinado">
            <div>
                <label>Mês/Ano</label>
                <input type="month" id="filtroMesAno" onchange="aplicarFiltros()">
            </div>
            <div>
                <label>Status</label>
                <select id="filtroStatus" onchange="aplicarFiltros()">
                    <option value="Todos">Todos</option>
                    <option>Atendendo</option>
                    <option>Encerrado</option>
                    <option>Instalação</option>
                    <option>Troca de Equipamento</option>
                    <option>Retirada de Equipamento</option>
                    <option>Mudança de Local</option>
                </select>
            </div>
            <div>
                <label>Busca Rápida</label>
                <input type="text" id="filtroBusca" placeholder="Buscar Unidade, CRE, Município, IMP..." onkeyup="aplicarFiltros()">
            </div>
            <button class="btn btn-limpar" onclick="limparFiltros()">Limpar Filtros</button>
        </div>

        <div class="table-wrap">
            <table>
                <thead>
                    <tr>
                        <th>AÇÃO</th>
                        <th>DATA</th>
                        <th>UNIDADE</th>
                        <th>MUNICÍPIO</th>
                        <th>CRE</th>
                        <th>TPSC</th>
                        <th>IMP</th>
                        <th>STATUS</th>
                        <th>OBSERVAÇÕES</th>
                        <th>OPERADOR</th>
                    </tr>
                </thead>
                <tbody id="corpoTabela"></tbody>
            </table>
        </div>
    </div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwJsIvdBu6EDwRF-PMOYNkBpYfnCXIInwGhJKq7F7Te0yj3ZiOHVq7NfhIr6tmQS5zw0Q/exec";
        let usuarioLogado = "";
        let registrosLocal = [];
        let idEditando = null;

        function fazerLogin() {
            usuarioLogado = document.getElementById('user-login').value;
            if(!usuarioLogado) return alert("Por favor, informe seu nome.");
            document.getElementById('nome-usuario-logado').innerText = "Operador: " + usuarioLogado;
            document.getElementById('tela-login').style.display = 'none';
            document.getElementById('container-principal').style.display = 'block';
            carregarTabela();
        }

        function formatarData(dataISO) {
            if (!dataISO || dataISO === '-') return '-';
            try {
                const d = new Date(dataISO);
                return isNaN(d.getTime()) ? dataISO : d.toLocaleString('pt-BR');
            } catch(e) { return dataISO; }
        }

        async function salvarRegistro() {
            const btn = document.getElementById('btnSalvar');
            const dados = {
                id: idEditando,
                data: idEditando ? undefined : new Date().toISOString(),
                unidade: document.getElementById('unidade').value,
                municipio: document.getElementById('municipio').value,
                cre: document.getElementById('cre').value,
                tpsc: document.getElementById('tpsc').value,
                chamado: document.getElementById('chamado').value,
                status: document.getElementById('status').value,
                defeito: document.getElementById('defeito').value,
                usuario_reg: usuarioLogado
            };

            if(!dados.unidade) return alert("O campo Unidade é obrigatório.");
            btn.disabled = true; btn.innerText = "Processando...";

            try {
                await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(dados) });
                alert(idEditando ? "Atualizado!" : "Salvo!");
                cancelarEdicao();
                carregarTabela();
            } catch (e) { alert("Erro de conexão."); }
            finally { btn.disabled = false; }
        }

        function prepararEdicao(id) {
            const r = registrosLocal.find(x => x.id == id);
            if(!r) return;
            idEditando = id;
            document.getElementById('unidade').value = r.unidade || '';
            document.getElementById('municipio').value = r.municipio || r.município || '';
            document.getElementById('cre').value = r.cre || '';
            document.getElementById('tpsc').value = r.tpsc || '';
            document.getElementById('chamado').value = r.chamado || r.imp || '';
            document.getElementById('status').value = r.status || 'Atendendo';
            document.getElementById('defeito').value = r.defeito || r.obs || '';
            
            document.getElementById('btnSalvar').innerText = "ATUALIZAR";
            document.getElementById('btnSalvar').style.background = "var(--azul-edit)";
            document.getElementById('btnCancelar').style.display = "block";
            window.scrollTo({top: 0, behavior: 'smooth'});
        }

        function cancelarEdicao() {
            idEditando = null;
            ['unidade','municipio','cre','tpsc','chamado','defeito'].forEach(i => document.getElementById(i).value = "");
            document.getElementById('btnSalvar').innerText = "SALVAR REGISTRO";
            document.getElementById('btnSalvar').style.background = "";
            document.getElementById('btnCancelar').style.display = "none";
        }

        async function carregarTabela() {
            const corpo = document.getElementById('corpoTabela');
            corpo.innerHTML = "<tr><td colspan='10' style='text-align:center'>Sincronizando dados...</td></tr>";
            try {
                const res = await fetch(SCRIPT_URL + "?t=" + new Date().getTime());
                registrosLocal = await res.json();
                aplicarFiltros();
            } catch (e) { corpo.innerHTML = "<tr><td colspan='10' style='color:red'>Erro ao carregar.</td></tr>"; }
        }

        function aplicarFiltros() {
            const mesAno = document.getElementById('filtroMesAno').value; // Formato YYYY-MM
            const status = document.getElementById('filtroStatus').value;
            const busca = document.getElementById('filtroBusca').value.toLowerCase();

            const filtrados = registrosLocal.filter(r => {
                // Filtro Mês/Ano
                let matchData = true;
                if (mesAno) {
                    const dataObj = new Date(r.data);
                    const itemMesAno = `${dataObj.getFullYear()}-${String(dataObj.getMonth() + 1).padStart(2, '0')}`;
                    matchData = (itemMesAno === mesAno);
                }

                // Filtro Status
                let matchStatus = (status === "Todos" || r.status === status);

                // Filtro Busca Geral
                let matchBusca = Object.values(r).some(v => String(v).toLowerCase().includes(busca));

                return matchData && matchStatus && matchBusca;
            });

            renderizarLinhas(filtrados);
        }

        function limparFiltros() {
            document.getElementById('filtroMesAno').value = "";
            document.getElementById('filtroStatus').value = "Todos";
            document.getElementById('filtroBusca').value = "";
            aplicarFiltros();
        }

        function renderizarLinhas(lista) {
            const corpo = document.getElementById('corpoTabela');
            corpo.innerHTML = "";
            let s = { t:0, a:0, e:0, i:0, o:0 };

            lista.slice().reverse().forEach(v => {
                s.t++;
                const stRaw = (v.status || '').toLowerCase();
                const stClass = stRaw.split(' ')[0]; 
                
                if(stRaw.includes('atendendo')) s.a++;
                else if(stRaw.includes('encerrado')) s.e++;
                else if(stRaw.includes('instalação')) s.i++;
                else s.o++;

                corpo.innerHTML += `
                    <tr>
                        <td><button class="btn btn-editar" onclick="prepararEdicao(${v.id})">Editar</button></td>
                        <td>${formatarData(v.data)}</td>
                        <td><b>${v.unidade || '-'}</b></td>
                        <td>${v.municipio || v.município || '-'}</td>
                        <td>${v.cre || '-'}</td>
                        <td>${v.tpsc || '-'}</td>
                        <td>${v.chamado || v.imp || '-'}</td>
                        <td><span class="badge status-${stClass}">${v.status || '-'}</span></td>
                        <td>${v.defeito || v.obs || '-'}</td>
                        <td><small>${v.usuario_reg || v.operador || '-'}</small></td>
                    </tr>`;
            });

            document.getElementById('stat-total').innerText = s.t;
            document.getElementById('stat-aberto').innerText = s.a;
            document.getElementById('stat-ok').innerText = s.e;
            document.getElementById('stat-inst').innerText = s.i;
            document.getElementById('stat-outros').innerText = s.o;
        }

        function exportarExcel() {
            const ws = XLSX.utils.json_to_sheet(registrosLocal);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Dados");
            XLSX.writeFile(wb, "Relatorio_Chamados.xlsx");
        }

        function exportarPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l');
            doc.text("Relatório SED SC", 10, 10);
            doc.autoTable({
                head: [['Data', 'Unidade', 'Status', 'Obs']],
                body: registrosLocal.map(v => [formatarData(v.data), v.unidade, v.status, v.defeito || v.obs])
            });
            doc.save("Relatorio.pdf");
        }
    </script>
</body>
</html>
