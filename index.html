<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISTEMA GESTÃO SED SC</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        :root { --verde-sed: #006437; --verde-escuro: #004d2a; --cinza-bg: #f4f7f6; --vermelho-sc: #dc3545; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--cinza-bg); margin: 0; padding: 0; }
        
        #tela-login { position: fixed; width: 100%; height: 100%; background: var(--verde-sed); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .login-box { background: white; padding: 40px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); text-align: center; width: 350px; border-top: 8px solid var(--vermelho-sc); }
        
        #container-principal { display: none; padding: 20px; }
        
        .header-main { background: white; padding: 15px 25px; border-radius: 10px; border-left: 10px solid var(--verde-sed); box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        .header-titulo h1 { margin: 0; font-size: 16px; color: var(--verde-sed); text-transform: uppercase; }

        .dashboard { display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px; margin-bottom: 20px; }
        .stat-card { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); text-align: center; border-bottom: 4px solid #ccc; }
        .stat-card b { font-size: 24px; color: var(--verde-sed); display: block; }

        .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .form-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }
        .span-2 { grid-column: span 2; }
        .span-4 { grid-column: span 4; }

        label { display: block; font-size: 11px; font-weight: bold; margin-bottom: 4px; color: #555; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 13px; box-sizing: border-box; }
        
        .btn { padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; transition: 0.3s; font-size: 12px; }
        .btn-salvar { background: var(--verde-sed); color: white; height: 42px; align-self: end; width: 100%; }
        .btn-salvar:hover { background: var(--verde-escuro); }

        .table-wrap { overflow-x: auto; max-height: 500px; border-radius: 8px; border: 1px solid #eee; background: white; }
        table { width: 100%; border-collapse: collapse; white-space: nowrap; }
        th { background: #f8f9fa; color: var(--verde-sed); font-size: 11px; padding: 12px; border-bottom: 2px solid #ddd; position: sticky; top: 0; text-align: left; }
        td { padding: 10px 12px; font-size: 12px; border-bottom: 1px solid #eee; }
        
        .badge { padding: 4px 8px; border-radius: 4px; font-weight: bold; font-size: 10px; text-transform: uppercase; }
        .status-atendendo { background: #fff3cd; color: #856404; }
        .status-encerrado { background: #d4edda; color: #155724; }
        .status-instalação { background: #cfe2ff; color: #084298; }
    </style>
</head>
<body>

    <div id="tela-login">
        <div class="login-box">
            <h2 style="color: var(--verde-sed); margin-bottom: 5px;">SISTEMA SED SC</h2>
            <p style="font-size: 12px; color: #666; margin-bottom: 25px;">Gestão de Impressoras - Cloud</p>
            <input type="text" id="user-login" placeholder="Nome do Operador">
            <br><br>
            <button class="btn btn-salvar" onclick="fazerLogin()">ACESSAR PAINEL</button>
        </div>
    </div>

    <div id="container-principal">
        <div class="header-main">
            <div class="header-titulo"><h1>Gerenciamento de Impressoras</h1></div>
            <div style="display: flex; gap: 10px; align-items: center;">
                <span style="font-size: 12px;">Operador: <strong id="nome-usuario-logado"></strong></span>
                <button class="btn" style="background: #e74c3c; color: white;" onclick="exportarPDF()">PDF</button>
                <button class="btn" style="background: #27ae60; color: white;" onclick="exportarExcel()">Excel</button>
                <button class="btn" style="background: #333; color: white;" onclick="location.reload()">Sair</button>
            </div>
        </div>

        <div class="dashboard">
            <div class="stat-card"><small>Total</small><b id="stat-total">0</b></div>
            <div class="stat-card"><small>Atendendo</small><b id="stat-aberto">0</b></div>
            <div class="stat-card"><small>Encerrados</small><b id="stat-ok">0</b></div>
            <div class="stat-card"><small>Instalação</small><b id="stat-inst">0</b></div>
            <div class="stat-card"><small>Outros</small><b id="stat-outros">0</b></div>
        </div>

        <div class="card">
            <div class="form-grid">
                <div class="span-2"><label>UNIDADE ESCOLAR</label><input type="text" id="unidade"></div>
                <div><label>MUNICÍPIO</label><input type="text" id="municipio"></div>
                <div><label>CRE</label><input type="text" id="cre"></div>
                <div><label>TPSC</label><input type="text" id="tpsc"></div>
                <div><label>IMP (Patrimônio)</label><input type="text" id="chamado"></div>
                <div>
                    <label>STATUS</label>
                    <select id="status">
                        <option>Atendendo</option>
                        <option>Encerrado</option>
                        <option>Instalação</option>
                        <option>Troca de Equipamento</option>
                        <option>Retirada</option>
                    </select>
                </div>
                <div style="display: flex; align-items: flex-end;">
                    <button class="btn btn-salvar" id="btnSalvar" onclick="salvarRegistro()">SALVAR REGISTRO</button>
                </div>
                <div class="span-4"><label>OBSERVAÇÕES / DEFEITO</label><textarea id="defeito" rows="2"></textarea></div>
            </div>
        </div>

        <div class="table-wrap">
            <table>
                <thead>
                    <tr>
                        <th>DATA</th>
                        <th>UNIDADE</th>
                        <th>MUNICÍPIO</th>
                        <th>CRE</th>
                        <th>TPSC</th>
                        <th>IMP</th>
                        <th>STATUS</th>
                        <th>OBSERVAÇÕES</th>
                        <th>OPERADOR</th>
                    </tr>
                </thead>
                <tbody id="corpoTabela"></tbody>
            </table>
        </div>
    </div>

    <script>
        // URL DO SEU APP DA WEB (CONFORME SUA IMAGEM)
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwJsIvdBu6EDwRF-PMOYNkBpYfnCXIInwGhJKq7F7Te0yj3ZiOHVq7NfhIr6tmQS5zw0Q/exec";
        
        let usuarioLogado = "";
        let registrosLocal = [];

        function fazerLogin() {
            usuarioLogado = document.getElementById('user-login').value;
            if(!usuarioLogado) return alert("Informe seu nome.");
            document.getElementById('nome-usuario-logado').innerText = usuarioLogado;
            document.getElementById('tela-login').style.display = 'none';
            document.getElementById('container-principal').style.display = 'block';
            carregarTabela();
        }

        // Função para formatar a data ISO para PT-BR
        function formatarData(dataISO) {
            if (!dataISO || dataISO === '-') return '-';
            try {
                const dataObj = new Date(dataISO);
                if (isNaN(dataObj.getTime())) return dataISO;
                return dataObj.toLocaleString('pt-BR', {
                    day: '2-digit', month: '2-digit', year: 'numeric',
                    hour: '2-digit', minute: '2-digit'
                });
            } catch (e) { return dataISO; }
        }

        async function salvarRegistro() {
            const btn = document.getElementById('btnSalvar');
            const dados = {
                data: new Date().toISOString(), // Enviamos formato ISO para o Google tratar
                unidade: document.getElementById('unidade').value,
                municipio: document.getElementById('municipio').value,
                cre: document.getElementById('cre').value,
                tpsc: document.getElementById('tpsc').value,
                chamado: document.getElementById('chamado').value,
                status: document.getElementById('status').value,
                defeito: document.getElementById('defeito').value,
                usuario_reg: usuarioLogado
            };

            if(!dados.unidade) return alert("Campo Unidade é obrigatório!");
            btn.disabled = true; btn.innerText = "Sincronizando...";

            try {
                await fetch(SCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(dados) });
                alert("Registro salvo com sucesso!");
                ['unidade','municipio','cre','tpsc','chamado','defeito'].forEach(id => document.getElementById(id).value = "");
                carregarTabela();
            } catch (e) { 
                alert("Erro ao conectar com o servidor."); 
            } finally { 
                btn.disabled = false; btn.innerText = "SALVAR REGISTRO"; 
            }
        }

        async function carregarTabela() {
            const corpo = document.getElementById('corpoTabela');
            corpo.innerHTML = "<tr><td colspan='9' style='text-align:center'>Carregando dados da Planilha Google...</td></tr>";
            
            try {
                const response = await fetch(SCRIPT_URL + "?t=" + new Date().getTime());
                const dados = await response.json();
                registrosLocal = dados;
                corpo.innerHTML = "";

                let s = { total: 0, aberto: 0, ok: 0, inst: 0, outros: 0 };

                // Inverter para ver os registros novos no topo
                dados.reverse().forEach(v => {
                    s.total++;
                    const st = (v.status || '').toLowerCase();
                    if(st.includes('atendendo')) s.aberto++;
                    else if(st.includes('encerrado')) s.ok++;
                    else if(st.includes('instalação')) s.inst++;
                    else s.outros++;

                    // MAPEAMENTO EXPLÍCITO DAS COLUNAS (Ignora o ID automaticamente)
                    corpo.innerHTML += `
                        <tr>
                            <td>${formatarData(v.data)}</td>
                            <td><b>${v.unidade || '-'}</b></td>
                            <td>${v.municipio || v.município || '-'}</td>
                            <td>${v.cre || '-'}</td>
                            <td>${v.tpsc || '-'}</td>
                            <td>${v.chamado || v.imp || '-'}</td>
                            <td><span class="badge status-${st.split(' ')[0]}">${v.status || '-'}</span></td>
                            <td>${v.defeito || v.obs || '-'}</td>
                            <td><small>${v.usuario_reg || v.operador || '-'}</small></td>
                        </tr>`;
                });

                document.getElementById('stat-total').innerText = s.total;
                document.getElementById('stat-aberto').innerText = s.aberto;
                document.getElementById('stat-ok').innerText = s.ok;
                document.getElementById('stat-inst').innerText = s.inst;
                document.getElementById('stat-outros').innerText = s.outros;

            } catch (e) { 
                corpo.innerHTML = "<tr><td colspan='9' style='color:red; text-align:center'>Erro ao carregar. Verifique a conexão.</td></tr>"; 
            }
        }

        function exportarExcel() {
            const ws = XLSX.utils.json_to_sheet(registrosLocal);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Dados");
            XLSX.writeFile(wb, "Relatorio_SED_SC.xlsx");
        }

        function exportarPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l');
            doc.text("Relatório de Manutenção de Impressoras - SED SC", 10, 10);
            doc.autoTable({
                head: [['Data', 'Unidade', 'Município', 'IMP', 'Status']],
                body: registrosLocal.map(v => [formatarData(v.data), v.unidade, v.municipio || v.município, v.chamado || v.imp, v.status]),
                startY: 20
            });
            doc.save("Relatorio_Impressoras.pdf");
        }
    </script>
</body>
</html>
